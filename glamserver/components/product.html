<!--
 * @ Name: product.html
 * @ Purpose:
 * @ Author: Ramel Niño O. Empleo
 * @ Create Time: 2022-09-15 09:11:53
 * @ Modified by: Ramel Niño O. Empleo
 * @ Modified time: 2023-01-25 21:08:17
 * @ Change Log:
 -->
<div class="container-scroller">
	<div class="container-fluid page-body-wrapper">
		<div id="leftSideNavigation" style="float: left"></div>
		<div class="main-panel">
			<div class="content-wrapper">
				<div class="row">
					<div class="col-sm-12">
						<div class="home-tab">
							<div class="d-sm-flex align-items-center justify-content-between border-bottom" >
								<ul class="nav nav-tabs" role="tablist">
									<li class="nav-item">
										<a
											class="nav-link active ps-0"
											id="home-tab"
											data-bs-toggle="tab"
											href="javascript:void(0)"
											role="tab"
											aria-controls="overview"
											aria-selected="true"
											><i class="mdi mdi-table"></i> Products</a
										>
									</li>
								</ul>
							</div>
							<div class="tab-content tab-content-basic">
								<div
									class="tab-pane fade show active"
									id="overview"
									role="tabpanel"
									aria-labelledby="overview"
								>
									<div class="row">
										<div class="col-lg-12 d-flex flex-column">
											<div class="row flex-grow">
												<div class="col-12 grid-margin stretch-card">
													<div class="card card-rounded">
														<div class="card-body">
															<table
																id="productTable"
																class="table table-striped"
																style="width: 100%"
															>
																<thead>
																	<tr>
																		<th></th>
																		<th>Id</th>
																		<th>Product Image</th>
																		<th>Product QR</th>
																		<th>Name</th>
																		<th>Description</th>
																		<th>Category</th>
																		<th>Availability</th>
																		<th>Price</th>
																		<th>Count</th>
																	</tr>
																</thead>
															</table>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- Modal -->
				<div class="modal fade bd-example-modal-lg" id="ProductModal" tabindex="-1" role="dialog" aria-labelledby="ProductModalTitle" aria-hidden="true">
					<div class="modal-dialog modal-lg" role="document">
					<div class="modal-content" style="max-height: 500px;">
						<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLongTitle">Product Record</h5>
						</div>
						<div class="modal-body" style="overflow-x: auto;">
							<div class="form-group">
								<label for="productImage"><i class="mdi mdi-regex text-danger"></i> Product Image</label>
								<input type="file" class="form-control form-control-sm" id="productImage" accept="image/jpeg" placeholder="Product image here...">
							</div>
							<div class="form-group">
								<label for="productGcashQR">Gcash QR Image</label>
								<input type="file" class="form-control form-control-sm" id="productGcashQR" accept="image/jpeg" placeholder="Gcash qr image here...">
							</div>
							<div class="form-group">
								<label for="productName"><i class="mdi mdi-regex text-danger"></i> Product Name</label>
								<input type="text" class="form-control" id="productName" placeholder="Product name here...">
							</div>
							<div class="form-group">
								<label for="productDescription"><i class="mdi mdi-regex text-danger"></i> Description</label>
								<textarea class="form-control form-control-lg" id="productDescription" rows="20" placeholder="Product description here..."></textarea>
							</div>
							<div class="form-group">
								<label for="productSize"><i class="mdi mdi-regex text-danger"></i> Size <small class="text-muted">(press ctrl key then click to select multiple options)</small></label>
								<select id="productSize" class="form-select" multiple>
									<option value="S">S</option>
									<option value="M">M</option>
									<option value="L">L</option>
									<option value="XL">XL</option>
								  </select>
							</div>
							<div class="form-group">
								<label for="productType"><i class="mdi mdi-regex text-danger"></i> Product Category</label>
								<select class="form-control" id="productType">
								</select>
							</div>
							<div class="form-group">
								<label for="productAmount"><i class="mdi mdi-regex text-danger"></i> Product Amount</label>
								<div class="input-group">
								  <div class="input-group-prepend">
									<span class="input-group-text bg-primary text-white">₱ </span>
								  </div>
								  <input id="productAmount" type="Number" min="0" step=".01" class="form-control" aria-label="Amount (to the nearest peso)">
								</div>
							</div>
							<div class="form-group">
								<label for="productCount"><i class="mdi mdi-regex text-danger"></i> Available</label>
								<div class="input-group">
								  <div class="input-group-prepend">
									<span class="input-group-text bg-primary text-white">Count:</span>
								  </div>
								  <input id="productCount" type="number" min="0" step="1" class="form-control" aria-label="Number of Items">
								  <div class="input-group-append">
									<span class="input-group-text">Item/Bundle</span>
								  </div>
								</div>
							</div>
						</div>
						<div class="modal-footer">
						<button id="saveRecord" type="button" class="btn btn-primary">Save changes</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
	$.ajax({
		type: 'POST',
		data: {'TYPE': 'getCategory'},
		url: "/glam/glamserver/assets/php/productCRUD.php", //My reference URL
		dataType : 'json',
		success: function(jsonData){
			console.warn("Log:  => $ => jsonData", jsonData);
			jsonData.forEach(row => {
				$('#productType').append(`
					<option>${row.gcat_name}</option>
				`);
			});
		}
	});
	$(document).ready(function () {
		function format(d) {
			var temp = [];
			var qr;
			if(d.gp_description.includes('[') || d.gp_description.includes('{')) {
				temp = d.gp_description.replace(/[{}]/g, "").split(':');
				temp[1] = temp[1].split('",');
				temp[0] = temp[1][0].replace(/["]/g, "");
				if(temp.length > 2) {
					temp[2] = JSON.parse(temp[2].substring(1).slice(0,-1));
				}else {
					temp[2] = 'Package - All sizes';
				}
			}else {
				temp[0] = d.gp_description;
				temp[2] = 'Package - All sizes';
			}
			if(d.gp_gcash_qr) {
				qr = `
				<a class="yBox" href="/glam/glamserver/assets/qrcodes/${d.gp_gcash_qr}" data-ybox-group="group${d.gpId}">
					<img src="/glam/glamserver/assets/qrcodes/${d.gp_gcash_qr}" />
				</a>
				`;
			}else {
				qr = 'No Gcash QR Code';
			}
			return (
				`<h5>Description</h5>
				<div style="width: auto; white-space: normal;">
					<p>${temp[0]}</p>
					<p><i class="mdi mdi-tshirt-crew"></i> Size: ${temp[2]}</p>
				</div>
				<div style="display: flex;flex-direction: row;">
					<div style="padding: 10px;">
						<p>
							<i class="mdi mdi-qrcode"></i> QR Code:<br />
							${qr}
						</p>
					</div>
					<div style="padding: 10px;">
						<p>
							<i class="mdi mdi-file-image"></i> Product Image:<br />
							<a class="yBox" href="/glam/glamserver/assets/contents/${d.gp_product_img}" data-ybox-group="group${d.gpId}">
								<img src="/glam/glamserver/assets/contents/${d.gp_product_img}" />
							</a>
						</p>
					</div>
				</div>`
			);
		}
		var recordCount = 0;
		var table = $("#productTable").DataTable({
			dom: "Bfrtip",
			responsive: true,
			select: true,
			scrollX: true,
			lengthMenu: [
				[5, 10, 15, -1],
				[5, 10, 15, 'All'],
        	],
			pagingType: 'full',
			buttons: [{
				text: "<i class=\"mdi mdi-file-import\"></i> New Record",
				className: "createProductRecord",
				action: function( e, dt, node, config ) {
					recordCount = table.page.info().recordsTotal;
					$('#saveRecord').html($('#saveRecord').text().replace('Update','Save'));
					$('#productName,#productDescription,#productType,#productAmount,#productImage,#productGcashQR,#productCount').removeClass('is-invalid').val('');
					$('#productSize').val([]);
					$('#ProductModal').modal('show');
				}
			},{
				text: `<i class="mdi mdi-shopping"></i> New Transaction`,
				action: function (e, dt, node, config) {
					sessionStorage.page='newTransaction';location.reload();
				}
			},{
                text: '<i class="mdi mdi-file-send"></i> Update Selected Row',
                action: function ( e, dt, node, config ) {
					$('#productSize').val([]);
					var record = dt.row('.selected').data();
					var price = [];
					if(record.gp_description.includes('[')||record.gp_description.includes('{')) {
						var temp = record.gp_description.replace(/[{}]/g, "").split(':');
						temp[1] = temp[1].split('",');
						$('#productDescription').val(temp[1][0].replace(/["]/g, ""));
						if(temp.length > 2) {
							$('#productSize').val(JSON.parse(temp[2].substring(1).slice(0,-1)));
						}
					}else {
						$('#productDescription').val(record.gp_description);
					}
					$('#saveRecord').val(record.gpId);
					$('#productName').val(record.gp_name);
					$('#productType').val(record.gp_type);
					price = record.gp_price.split('.');
					price[0] = price[0].replace(/\₱ /g, "");
					price[3] = price[0] +'.'+ price[1];
					$('#productAmount').val(parseFloat(price[3]).toFixed(2));
					$('#productCount').val(record.gp_count);
					$('#saveRecord').html($('#saveRecord').text().replace('Save','Update'));
					$('#ProductModal').modal('show');
                },
				enabled: false
            },{
                extend: 'pdfHtml5',
				text:      '<i class="mdi mdi-file-export"></i> Generate PDF',
				title: 'Product Records',
                titleAttr: 'PDF',
                orientation: 'landscape',
                pageSize: 'LEGAL',
				download: 'open'
            }],
			processing: true,
			serverSide: true,
			ajax: "assets/php/product.php",
			columns: [
					{
						class: 'details-control',
						orderable: false,
						data: null,
						defaultContent: "<i class='icon-plus'></i>",
					},
					{ data: 'gpId'},
					{ data: 'gp_product_img' },
					{ data: 'gp_gcash_qr' },
					{ data: 'gp_name' },
					{ data: 'gp_description' },
					{ data: 'gp_type' },
					{ data: 'gp_count'},
					{ data: 'gp_price' },
					{ data: 'gp_count' },
			],
			columnDefs: [
				{
					target: [1,2,3,5],
					visible: false,
					searchable: false,
				},
        	],
			order: [[4, 'asc']],
			initComplete: function () {

			}
		});
		$('#productTable tbody').on('click', 'tr', function () {
			var selectedRows;
			if(this.classList.value != '') {
				if ($(this).hasClass('selected')) {
					$(this).removeClass('selected');
					selectedRows = table.$('tr.selected').length;
				} else {
					table.$('tr.selected').removeClass('selected');
					$(this).addClass('selected');
					selectedRows = table.$('tr.selected').length;
				}
				table.button( 2 ).enable( selectedRows === 1 );
			}
		});
		// Array to track the ids of the details displayed rows
		var detailRows = [];
 
		$('#productTable tbody').on('click', 'tr td.details-control', function () {
			var tr = $(this).closest('tr');
			var row = table.row(tr);
			var idx = detailRows.indexOf(tr.attr('id'));
	 
			if (row.child.isShown()) {
				tr.removeClass('details');
				row.child.hide();
	 
				// Remove from the 'open' array
				detailRows.splice(idx, 1);
			} else {
				tr.addClass('details');
				row.child(format(row.data())).show();
	 
				// Add to the 'open' array
				if (idx === -1) {
					detailRows.push(tr.attr('id'));
				}
			}
		});
	 
		// On each draw, loop over the `detailRows` array and show any child rows
		table.on('draw', function () {
			detailRows.forEach(function(id, i) {
				$('#' + id + ' td.details-control').trigger('click');
			});
		});
		$('#saveRecord').on('click', (event) => {
			$('#productName,#productDescription,#productType,#productAmount,#productImage,#productCount').removeClass('is-invalid');
			var form = new FormData();
			var Description = {};
			var loadData = [];
			var myFormData = document.getElementById('productImage').files[0]; //get the file 
			var myFormData2 = document.getElementById('productGcashQR').files[0]; //get the file 
			if(event.currentTarget.innerText.includes('Update')) {
				if (myFormData) {   //Check the file is emty or not
					form.append('inputFile', myFormData); //append files
					$.ajax({
						type: 'POST',
						processData: false,
						contentType: false,
						data: form,
						url: "/glam/glamserver/assets/php/saveImage.php", //My reference URL
						dataType : 'json',
						success: function(jsonData){
							console.warn("Log:  => $ => jsonData", jsonData);
						}
					});
				}
				form = new FormData();
				if (myFormData2) {   //Check the file is emty or not
					form.append('inputFile', myFormData2); //append files
					$.ajax({
						type: 'POST',               
						processData: false,
						contentType: false, 
						data: form,
						url: "/glam/glamserver/assets/php/saveqr.php", //My reference URL
						dataType : 'json',  
						success: function(jsonData){
							console.warn("Log:  => $ => jsonData", jsonData);
						}
					});
				}

				var recordData = '';
				if($('#productName').val()) {
					recordData += `gp_name = '${$('#productName').val()}', `;
				}
				if($('#productDescription').val()) {
					Description.Description = $('#productDescription').val();
				}
				if($('#productSize').val().length > 0) {
					Description.Size = JSON.stringify($('#productSize').val());
				}
				recordData += `gp_description = '${JSON.stringify(Description)}', `;
				if($('#productType').val()) {
					recordData += `gp_type = '${$('#productType').val()}', `;
				}
				if($('#productAmount').val()) {
					recordData += `gp_price = '${$('#productAmount').val()}'`;
				}
				if(myFormData) {
					recordData += `, gp_product_img = '${myFormData.name}'`;
				}
				if(myFormData2) {
					recordData += `, gp_gcash_qr = '${myFormData2.name}'`;
				}
				if($('#productCount').val()) {
					recordData += `, gp_count = ${$('#productCount').val()}`;
				}
				loadData = [{...loadData, TYPE: "updateProduct", filter: `gpId = ${$('#saveRecord').val()}`, params: recordData}];
				$.ajax({
						type: "POST",
						url: "/glam/glamserver/assets/php/productCRUD.php",
						data: loadData[0],
				}).done((data) => {
					if(data === 'Product updated!') {
						$('#ProductModal').modal('hide');
						table.draw();
						$.notify({
							title: 'Product Created',
							message: `Product name: ${$('#productName').val()} has been updated.`,
						},{
							showProgressbar: true,
							type: "success",
							allow_dismiss: false,
							placement: {
								from: 'top',
								align: 'right'
							}
						});
					}else {
						$.notify({
							title: 'Error',
							message: `Product name: ${$('#productName').val()} was not updated.`,
						},{
							showProgressbar: true,
							type: "danger",
							allow_dismiss: false,
							placement: {
								from: 'top',
								align: 'right'
							}
						});
					}
				});
			}else {
				if (myFormData) {   //Check the file is emty or not
					form.append('inputFile', myFormData); //append files
					$.ajax({
						type: 'POST',               
						processData: false,
						contentType: false, 
						data: form,
						url: "/glam/glamserver/assets/php/saveImage.php", //My reference URL
						dataType : 'json',  
						success: function(jsonData){
							console.warn("Log:  => $ => jsonData", jsonData);
						}
					});
				}else {
					$('#productImage').addClass('is-invalid').prop('title', 'this is required!').focus();
					return;
				}
				form = new FormData();
				if (myFormData2) {   //Check the file is emty or not
					form.append('inputFile', myFormData2); //append files
					$.ajax({
						type: 'POST',               
						processData: false,
						contentType: false, 
						data: form,
						url: "/glam/glamserver/assets/php/saveqr.php", //My reference URL
						dataType : 'json',  
						success: function(jsonData){
							console.warn("Log:  => $ => jsonData", jsonData);
						}
					});
				}

				var recordData = `${recordCount}, `;
				if($('#productName').val()) {
					$('#productName').removeClass('is-invalid');
					recordData += `"${$('#productName').val()}", `;
				}else {
					$('#productName').addClass('is-invalid').prop('title', 'this is required!').focus();
					return;
				}
				if($('#productDescription').val()) {
					Description.Description = $('#productDescription').val();
				}else {
					$('#productDescription').addClass('is-invalid').prop('title', 'this is required!').focus();
					return;
				}
				if($('#productSize').val().length > 0) {
					Description.Size = JSON.stringify($('#productSize').val());
				}
				/*else {
					$('#productSize').addClass('is-invalid').prop('title', 'this is required!').focus();
					return;
				}*/
				recordData += `'${JSON.stringify(Description)}', `;
				if($('#productType').val()) {
					recordData += `"${$('#productType').val()}", `;
				}else {
					$('#productType').addClass('is-invalid').prop('title', 'this is required!').focus();
					return;
				}
				if($('#productAmount').val()) {
					recordData += `${$('#productAmount').val()}`;
				}else {
					$('#productAmount').addClass('is-invalid').prop('title', 'this is required!').focus();
					return;
				}
				if(myFormData) {
					recordData += `, "${myFormData.name}"`;
				}
				if(myFormData2) {
					recordData += `, "${myFormData2.name}"`;
				}else {
					recordData += `, ""`;
				}
				if($('#productCount').val()) {
					recordData += `, ${$('#productCount').val()}`;
				}else {
					$('#productCount').addClass('is-invalid').prop('title', 'this is required!').focus();
					return;
				}
				recordData += ', ""';
				loadData = [{...loadData, TYPE: "createProduct", params: recordData}];
				$.ajax({
					type: "POST",
					url: "/glam/glamserver/assets/php/productCRUD.php",
					data: loadData[0],
				}).done((data) => {
					if(data === 'Product created!') {
						$('#ProductModal').modal('hide');
						table.draw();
						$.notify({
							title: 'Product Created',
							message: `Product name: ${$('#productName').val()} has been created.`,
						},{
							showProgressbar: true,
							type: "success",
							allow_dismiss: false,
							placement: {
								from: 'top',
								align: 'right'
							}
						});
					}else {
						$.notify({
							title: 'Error',
							message: `Product name: ${$('#productName').val()} was not created.`,
						},{
							showProgressbar: true,
							type: "danger",
							allow_dismiss: false,
							placement: {
								from: 'top',
								align: 'right'
							}
						});
					}
				});
			}
		});
	});
</script>
